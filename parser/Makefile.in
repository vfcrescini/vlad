# Vino Crescini <jcrescin@cit.uws.edu.au>

TOPSRCDIR = @top_srcdir@
DISTDIR = @DISTDIR@
CC = @CC@
CXX = @CXX@
LEX = @LEX@
YACC = @YACC@
CFLAGS = @CFLAGS@
CXXFLAGS = @CXXFLAGS@
LN_S = @LN_S@
TARGETS = libparser.a
INCLUDES = parser.h
OBJECTS = program_parser.o program_scanner.o operation_parser.o operation_scanner.o

all : copy-includes copy-targets

copy-includes : $(INCLUDES)
	@mkdir -p $(DISTDIR)/include/vlad
	@for i in $(INCLUDES); do \
	(cd $(DISTDIR)/include/vlad && $(LN_S) -f ../../../parser/$$i $$i); \
	done

copy-targets : $(TARGETS)
	@mkdir -p $(DISTDIR)/lib/vlad
	@for i in $(TARGETS); do \
	(cd $(DISTDIR)/lib/vlad && $(LN_S) -f ../../../parser/$$i $$i); \
	done

libparser.a : $(OBJECTS)
	$(AR) -rcs $(@) $(OBJECTS)

operation_scanner.o : operation.tab.h lex.operation.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c lex.operation.cpp

operation_parser.o : operation.tab.h operation.tab.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c operation.tab.cpp

program_scanner.o : program.tab.h lex.program.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c lex.program.cpp

program_parser.o : program.tab.h program.tab.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c program.tab.cpp

lex.operation.cpp : operation.l
	$(LEX) -Poperation operation.l && mv -f lex.operation.c $(@)

lex.program.cpp : program.l
	$(LEX) -Pprogram program.l && mv -f lex.program.c $(@)

operation.tab.cpp : operation.y
	$(YACC) -b operation -p operation operation.y && mv -f operation.tab.c $(@)

operation.tab.h : operation.y
	$(YACC) -b operation -p operation -d operation.y

program.tab.cpp : program.y
	$(YACC) -b program -p program program.y && mv -f program.tab.c $(@)

program.tab.h : program.y
	$(YACC) -b program -p program -d program.y

clean :
	$(RM) $(OBJECTS) lex.*.cpp *.tab.cpp *.tab.h

distclean : clean
	$(RM) $(TARGETS) Makefile
	@for i in $(INCLUDES); do \
	$(RM) $(DISTDIR)/include/vlad/$$i; \
	done
	@for i in $(TARGETS); do \
	$(RM) $(DISTDIR)/lib/vlad/$$i; \
	done
