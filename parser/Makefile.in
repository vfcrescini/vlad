# Vino Crescini <jcrescin@cit.uws.edu.au>

TOPSRCDIR = @top_srcdir@
DISTDIR = @DISTDIR@
CC = @CC@
CXX = @CXX@
LEX = @LEX@
YACC = @YACC@
CFLAGS = @CFLAGS@
CXXFLAGS = @CXXFLAGS@
TARGETS = libparser.a
INCLUDES = parser.h
OBJECTS = program_parser.o program_scanner.o query_parser.o query_scanner.o

all : copy-includes copy-targets

copy-includes : $(INCLUDES)
	@mkdir -p $(DISTDIR)/include/vlad
	@for i in $(INCLUDES); do \
	ln -sf ../../../parser/$$i $(DISTDIR)/include/vlad; \
	done

copy-targets : $(TARGETS)
	@mkdir -p $(DISTDIR)/lib/vlad
	@for i in $(TARGETS); do \
	ln -sf ../../../parser/$$i $(DISTDIR)/lib/vlad; \
	done

libparser.a : $(OBJECTS)
	$(AR) -rcs $(@) $(OBJECTS)

query_scanner.o : query.tab.h lex.query.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c lex.query.cpp

query_parser.o : query.tab.h query.tab.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c query.tab.cpp

program_scanner.o : program.tab.h lex.program.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c lex.program.cpp

program_parser.o : program.tab.h program.tab.cpp
	$(CXX) $(CXXFLAGS) -o $(@) -c program.tab.cpp

lex.query.cpp : query.l
	$(LEX) -Pquery query.l && mv -f lex.query.c $(@)

lex.program.cpp : program.l
	$(LEX) -Pprogram program.l && mv -f lex.program.c $(@)

query.tab.cpp : query.y
	$(YACC) -b query -p query query.y && mv -f query.tab.c $(@)

query.tab.h : query.y
	$(YACC) -b query -p query -d query.y

program.tab.cpp : program.y
	$(YACC) -b program -p program program.y && mv -f program.tab.c $(@)

program.tab.h : program.y
	$(YACC) -b program -p program -d program.y

clean :
	$(RM) $(OBJECTS) lex.*.cpp *.tab.cpp *.tab.h

distclean : clean
	$(RM) $(TARGETS) Makefile
	@for i in $(INCLUDES); do \
	$(RM) $(DISTDIR)/include/vlad/$$i; \
	done
	@for i in $(TARGETS); do \
	$(RM) $(DISTDIR)/lib/vlad/$$i; \
	done
